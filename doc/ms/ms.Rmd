---
title: "Manuscript title here"
author:
  - James R. Junker:
      email: jrjunker@mtu.edu
      institute: [msu, glrc]
      correspondence: true
  - name: Wyatt F. Cross
    institute: msu
  - name: James M. Hood
    institute: osu
  - name: Jonathan P. Benstead
    institute: bama
  - name: Alex D. Huryn
    institute: bama
  - name: Daniel Nelson
    institute: usu
  - name: Jon S. Olafsson
    institute: veidi
  - name: Gisli M. Gislason
    institute: reyk
institute:
  - msu: Dept. of Ecology, Montana State University, Bozeman, MT USA
  - glrc: Current `address:` Great Lakes Research Center, Michigan Technological University, Houghton, MI USA
  - osu: 
  - bama: 
  - usu: 
  - veidi: 
  - reyk: 
output:
   word_document:
      reference_docx: working_docx_template.docx
      toc: no
      pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
   pdf_document:
     keep_tex: true
   html_document: default
   pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
header-includes:
- \usepackage{lineno}
- \usepackage{amsmath}
- \usepackage{indentfirst}
- \linenumbers
indent: true
linestretch: 1
bibliography: refs.bib
link-citations: no
link-color: grey
csl: ecology.csl
---

```{r import general objects, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("./packages.R")
library(knitr)

drake::loadd(temperature_stats)
n_boot = temperature_stats[['n_boot']]


```
<!--- Title page details --->
<!-- \setlength\parindent{24pt}\setlength{\parskip}{0.0pt plus 1.0pt} -->

\newpage

<!--- this is a note in Rmarkdown --->

# Abstract

Energy fluxes through invertebrate food webs restructured in response to temperature. Specifically, communities in warmer streams were composed of smaller-bodied and higher-turnover populations on average. Additionally, energy fluxes of warmer streams were unequally skewed towards small-bodied, high-turnover populations *within* the community, suggesting higher temperatures restructured energy fluxes in both an absolute and relative sense across and within communities.

\newpage

# Introduction

<!--- warming and effects in food webs --->
Temperature is an important abiotic variable with increasing relevance as warming global temperatures alter the diversity, structure, and functioning of Earth's ecosystems
[@walther2002]. The effects of temperature on ecosystems manifest through complex direct and indirect pathways such as shifting species ranges and subsequent changes to local and regional communities [@root2003], species adaptations [@gibert2017], and through effects on individual metabolic rates [@brown2004; @gillooly2001]. 

<!--- Speeding up of food web: Species levels--->
Temperature has the potential to alter the provision and maintenance of ecosystem services by modifying the network of interactions among species [@brose2012; @woodward2010] that underpin ecosystem functions [@deruiter1995; @thompson2012]. Across global climate gradients, temperature mediates the dynamics and stability of food webs [@baiser2019] by altering the acquisition and allocation of resources among species [@zhang2017] and ultimately the magnitudes and relative distribution of biomass and interactions among species and trophic levels [@may1972; @mccann1998; @barnes2018; @gibert2019]. Importantly, these effects operate directly through temperature's influence on individual metabolic rates [@gillooly2001, @brown2004] and biological activity [e.g., attack rate, handling time, growth rates, etc.; @dell2014], and indirectly through the distribution of species traits, such as body size, within and across species [@bideault2019; @nelson2017]... 

<!--- Connect traits to the 'speed' of ecosystem energy fluxes--->

In fact, reduced organismal body size with warming is considered a 'universal' response of climate change.... 

Here, we measured the patterning and distribution of organic matter fluxes within invertebrate food webs across a natural stream temperature gradient (\~5 - 28$^\circ$C). Previous research in these streams has shown a strong positive effect of temperature on primary production both among streams [@demars2011; @padfield2017] and within streams seasonally
[@ogorman2012; @hood2018]. Consumers rely largely on autochthonous resources [@ogorman2012; @nelson2020] and therefore the dynamics of primary production have a strong control on consumer energy demand [@junker2020]. As such, we predicted total annual OM fluxes to consumers to scale with among-stream patterns in resource availability and consumer energy demand and increase with temperature across streams. We further expected that increasing temperature would reduce consumer species richness [@ogorman2019], thereby altering how OM fluxes are distributed within and across communities. The distribution of OM fluxes to consumers will shift towards relatively faster, higher turnover consumer at higher temperatures, 'speeding up' consumer dynamics both through direct effects on consumer turnover and through a decrease in mean body size. 

# Methods

We studied six streams within the Hengill geothermal field of southwestern Iceland (64$^\circ$ 03'N 021$^\circ$ 18'W) that varied in mean annual temperature. Hengill is
characterized by indirect geothermal heating of groundwater [@arnason1969], leading to a natural variability in water temperatures (4.5--54.0 $^\circ$C), but similar solute
chemistries [@friberg2009]. These conditions create a "natural laboratory" for isolating the effects of temperature on ecosystem processes [@ogorman2014; @nelson2017a]. We selected
streams to maximize the temperature range, while minimizing differences in the structural aspects of primary producers. In each stream, we measured temperature and water depth
every 15 min from July 2010 through August 2012 (U20-001-01 water-level logger, Onset Computer Corp. Pocasset, MA, USA). Light availability in the watershed was measured every 15
min from atmospheric stations (HOBO pendant temperature/light UA-002-64, Onset Computer Corp. Pocasset, MA, USA).

## Invertebrate sampling

We sampled macroinvertebrate communities approximately monthly from July 2011 to August 2012 in four streams and from October 2010 to October 2011 in two streams used in a previous
study (*n* = 6 streams). The two streams were part of an experiment beginning October 2011, therefore overlapping years were not used to exclude the impact of experimental
manipulation [@nelson2017; @nelson2017a]. Inter-annual comparisons of primary and secondary production in previous studies showed minimal differences among years in
unmanipulated streams, suggesting that combining data from different years would not significantly bias our results [@nelson2017; @hood2018]. We collected fiver Surber samples
(0.023 m^2^, 250 $\mu$m mesh) from randomly selected locations within each stream. Within the sampler, inorganic substrates were disturbed to \~10 cm depth and invertebrates and
organic matter were removed from stones with a brush. Samples were then preserved with 5% formaldehyde until laboratory analysis. In the laboratory, we split samples into coarse
(\>1 mm) and fine (\<1 mm but \>250 $\mu$m) fractions using nested sieves and then removed invertebrates form each fraction under a dissecting microscope (10--15 x magnification).
For particularly large samples, fine fractions were sub-sampled (1/2--1/16th) using a modified Folsom plankton splitter prior to removal of invertebrates. Subsamples were scaled to
the rest of the sample assuming similar abundance and body size distributions. Macroinvertebrates were identified to the lowest practical taxonomic level (usually genus) with
taxonomic keys [@peterson1977; @merritt2008; @andersen2013]. Taxon-specific abundance and biomass were scaled to a per meter basis by dividing by the Surber sampler area.

## Secondary Production

Daily secondary production of invertebrate taxa was calculated using the instantaneous growth rate method [IGR; @benke2017]. Growth rates were determined using taxon appropriate
approaches described in [@junker2020]. Briefly, growth rates of common taxa (e.g., Chironomidae spp., *Radix balthica*, etc.) were determined using *in situ* chambers [@huryn1986].
Multiple individuals (*n* = 5--15) within small size categories (\~1 mm length range) were photographed next to a field micrometer, placed into the stream within pre-conditioned
chambers for 7--15 days, after which they were again photographed. Individual lengths were measured from field pictures using image analysis software [@schindelin2012], and body
lengths were converted to mass (mg ash-free dry mass [AFDM]) using published length-mass regressions [@benke1999; @ogorman2012; @hannesdottir2013]. Growth rates (*g*, d^-1^) were
calculated by the changes in mean body size (*W*) over a given time interval (*t*) with the following equation:

$$g = log_e ( W_{t+\Delta t} / W_t) / \Delta t$$

Variability in growth rates was estimated by bootstrapping through repeated resampling of individual lengths with replacement (*n* = 1000). For taxa which exhibit synchronous growth
and development (e.g., Simuliidae spp., some Chironomidae spp., etc.), we examined temporal changes in length-frequency distributions and calculated growth rates and uncertainty
using a bootstrap technique similar to that described in Benke and Huryn [-@benke2017]. Individual Lengths were converted to mg AFDM using published length-mass regression cited
above and size-frequency histograms were visually inspected for directional changes in body size through time. For each date, size-frequency distributions were resampled with
replacement and growth rates estimated from equation 1. We prevented the calculation of negative growth rates by requiring $W_{t + \Delta t}$ \> $W_t$. To estimate
growth rates of taxa for which growth could not be estimated empirically, we developed stream-specific growth rate models by constructing multivariate linear regressions of
empirical growth data against body size and temperature within each stream. To estimate uncertainty in production of each taxon, we used a bootstrapping technique that resampled
measured growth rates, in addition to abundance and size distributions from individual samples. For each iteration, size-specific growth rates were multiplied by mean
interval biomass for each size class and the number of days between sample dates to estimate size class-specific production. For each interval, size classes were summed for each
taxon to calculate total population-level production. Intervals were summed to estimate annual secondary production.

## Diet analysis

**Come back and confirm this section** Macroinvertebrate diets were quantified for dominant taxa in each stream. We focused on numerically abundant taxa and/or taxa with relatively
high annual production. A minimum of five individuals were selected from samples, and, when possible included individuals of different size classes to account for ontogenetic
shifts in diet. We included individuals from different seasons to capture concurrent ontogenetic and seasonal changes. For small-bodied taxa, we combined multiple individuals (*n*
= 3--5) to ensure samples contained enough material for quantification. We used methods outlined in Rosi-Marshall [-@rosi-marshall2016] to remove gut tracts and prepare gut content
slides. Briefly, we removed the foregut from each individual or collection of individuals and sonicated gut contents in water for 30 seconds. Gut content slurries were filtered
onto gridded nitrocellulose membrane filters (Metricel GN-6, 25 mm, 0.45 $\mu$m pore size; Gelman Sciences, Ann Arbor, MI, USA), dried at 60 $^\circ$C for 15 min, placed on a
microscope slide, cleared with Type B immersion old, and covered with a cover slip. We took 5--10 random photographs under 200--400x magnification, depending on the density of
particles, using a digital camera mounted on a compound microscope. From these photographs we identified all particles within each field and measured the relative area of particles
using image analysis software [@schindelin2012]. We identified particles as diatoms, green and filamentous algae, cyanobacteria, amorphous detritus, vascular and non-vascular
plants (e.g., bryophytes), and animal material. We calculated the proportion of each food category in the gut by dividing their summed area by the total area of all particles. Gut
contents of many predators were empty or contained unidentifiable, macerated prey. For these taxa, we assumed 100% animal material.

To estimate variability in diet compositions and to impute missing values for non-dominant, yet present, taxa, we modeled the diet proportions within each stream using a
hierarchical multivariate model [@fordyce2011, @coblentz2017]. Here, the diet of a consumer population, *i*, in stream, *j*, is a multinomial vector,$\overrightarrow{y_{ij}}$, of
$$\overrightarrow{y_{ij}} \sim Multinomial(\overrightarrow{p_{ij}}, n_{ij})$$ $$\overrightarrow{p_i} \sim Dirichlet(\overrightarrow{q_i} \times  \alpha) $$ where, $\overrightarrow{p_i}$, is
a vector of consumer diet proportions, $\overrightarrow{q_i}$ is a vector of the population's diet proportions and $\alpha$ is a concentration parameter of the Dirichlet process.
We used uniform priors for $\overrightarrow{q_i}$ and $\alpha$, $$\overrightarrow{q_i} \sim Dirichlet(\overrightarrow{\textbf{1}})$$ $$\alpha \sim Uniform(0,\textit{c})$$ where,
$\overrightarrow{\textbf{1}}$ is a vector of ones the same length of basal resource types and $\textit{c}$ is the presumed maximum value the concentration value. **add in
site-level model parameter and model fitting language** . Models were fit in Stan with the 'brms' package in R [@burkner2017]. For non-dominant taxa, diet proportions were imputed
from the hierarchical model by resampling from posterior distributions. Importantly, this process allowed to maintain the hierarchical structure of the data when imputing missing
values.

From modeled diet compositions, we estimated trophic redundancy within and across stream food webs by calculating proportional similarities [*PS*; @whittaker1952] among modeled diet estimates. Proportional similarities were calculated as:

$$ PS = 1 - 0.5 \sum_{j=1}^S|p_{x,i} - p_{y,i}|$$

where, *p~x,i~* is the proportion of food resource *i* in the diet of taxon *x*, *p~y,i~* is the proportion of food resource *i* in the diet of taxon *y*, and there are *S* food categories. Proportional similarity was calculated across all taxa within a stream based on modeled diet contributions from each taxon. To calculate *PS* among streams we sampled 1000 estimates of the mean stream-level diet proportions for each stream and calculated *PS* for each. 

## Organic Matter Consumption Estimates

Consumption fluxes (g m^-2^ t^-1^) were calculated using the trophic basis of production method (TBP; [@benke1980]. Taxon-specific secondary production estimates were combined with
diet proportions, diet-specific assimilation efficiencies, *AE~i~*, and assumed net production efficiencies, *NPE*, to estimate consumption of organic matter. For each food
category, *i*, diet proportions were multiplied by the gross growth efficiency ($GGE_{i} = AE_{i} * NPE$) to calculate the relative production attributable to each food
category. The relative production from each food type was then multiplied by the interval-level production and finally divided by $GGE_{i}$ to estimate consumption of organic
matter from each food category by a consumer [@benke1980]. Consumption was calculated for each taxon across sampling intervals (typically \~1 month). Total interval consumption was
calculated by summing across all taxa, while annual consumption was calculated by summing across all taxa and intervals. Variability in consumption estimates was estimated through
a Monte Carlo approach, wherein bootstrapped vectors of secondary production for each taxon (see *Secondary production* methods above) were resampled and consumption estimated with
the TBP method using modeled diet proportions (see *Diet analysis* above), diet-specific assimilation efficiencies, and net production efficiency. Variability in *AE~i~* was
incorporated by resampling values from beta distributions fit to median and 2.5% and 97.5% percentiles for each diet item: diatoms = 0.30 (95% percentile interval (PI): 0.24-0.36),
filamentous and green algae = 0.30 (95% PI: 0.24-0.36), cyanobacteria = 0.10 (95% PI: 0.08-0.12), amorphous detritus = 0.10 (95% PI: 0.08-0.12), vascular and non-vascular plants
(bryophytes) = 0.1 (95% PI:: 0.08-0.12), and animal material = 0.7 (95% PI: 0.56-0.84)[@welch1968; @cross2007; @cross2011; @benke1980; @benke1997]. Variability in *NPE* was
incorporated by resampling values from an assumed beta distribution with median *NPE* = 0.45 (95% PI = 0.4-0.5). Beta distributions were fit using the 'get.beta.par()' function
within the *rriskDistributions* package [@belgorodski2017].

## Quantifying the distribution of food web fluxes

### Evenness Among consumers

To visualize and quantify how evenly OM fluxes were distributed among consumers within a stream, we constructed Lorenz curves [@lorenz1905] on ordered relative consumption fluxes, such that in a community with $S$ species and the relative consumption of species *i*, $p_i$, is ordered $p_1 \leq p_2 \leq ... p_S$. The Lorenz curve plots how a value, in this case OM flux, accumulates with increasing cumulative proportion of species. In a community with perfectly equal distribution of OM consumption among species, the Lorenz curve is simply a straight diagonal line. Deviation from perfect equality was calculated as the Gini coefficient [@gini1921], normalized for differences in $S$ among streams, $G^*$ [@solomon1975; @chao2019]: $$ G^* = (2 \sum_{i = 1}^S ip_i -2)/(S-1)$$ 

### Distribution along species' trait axes

We were interested in the question of how temperature may select for certain species traits (i.e., body size, $P:B$ ratio, population biomass) and therefore OM fluxes would skew towards populations with those traits. To detect this, for all bootstrapped estimates of annual OM flux, we ordered species based on within-stream ranking of annual population traits (i.e, $M$, $P:B$) and then calculated a measure of skewness, $Sk_{flux}$, based on quartiles of the distribution of OM fluxes in relation to species traits as:

$$Sk_{flux} = f_{Q0.75} - 2f_{Q0.5} + f_{Q0.25}/ f_{Q0.75}-f_{Q0.25}$$

where, $f_{Qx}$, is the cumulative flux at some quantile, $Qx$, of the community trait distribution. To determine if this outcome was due to random ordering, we first had to account for statistical constraints that restrict the range of possible outcomes [\ i.e., feasible set, @haegeman2008; @diaz2021a], given the number of species and the relative distribution of energy fluxes within a community. The number of unique orderings of species increases to computationally intractable numbers very quickly (e.g., $S!$, 10 species ~3.6e^6^ unique orderings). Therefore, we chose to permute a portion of each stream community's feasible set by randomly ordering species and calculating the skewness in the cumulative distribution of annual OM fluxes 100,000 times. The number of random orderings was chosen as a balance between characterizing the relative distribution of skewness values within each feasible set and computational and time constrains. This permuted set allowed us to calculate the probability of observing the empirical skewness, $Sk_{flux}$, in each stream compared to a random ordering given the distribution of relative energy flux.

## Statistical Analyses

Relationships between mean annual temperature ($^\circ$C) and mean community *M* and *P:B* were assessed with bootstrapped linear regressions. Here, `r temperature_stats[['n_boot']]` values of mean *M* or *P:B* were resampled with replacement from each stream. For each resampling event, a linear model was fit between *log~e~*-transformed *M* or *P:B* and mean annual temperature. Response variables *M* and *P:B* were transformed to meet the assumption of normally distributed residual variation. We similarly used a bootstrapped beta regression approach to test for relationships between annual stream temperature and the skewness of fluxes, $Sk_{flux}$, with *M* and *P:B*. Skewness coefficients exist in the range [-1, 1], therefore we applied a simple transformation, 
$$ (Sk_{flux} - 1)/2 $$ 
to standardize the values between 0 and 1 to meet the assumptions of the model. Coefficients were back-transformed to estimate effect sizes. To detect changes in 'random' vs. non-random assembly, we  again used beta regression on estimates of the probability of seeing the empirical $Sk_{flux}$ value or one more extreme based on random ordering of species in the permuted feasible set. Here, values can take the range between 0 and 1 so no transformation was necessary. Because we observed many values near 0 and 1, we implemented a zero-one inflated beta regression in the *zoib* package in R [@]

# Results

```{r load objects from cache, echo = FALSE, warning = FALSE, message=FALSE}
library(tidyverse)
 drake::loadd(flux_estimates)
 energy_demand = flux_estimates[["energy_demand"]]
 comm_energy_demand_summary = energy_demand %>%
    group_by(site, boot_id) %>% 
    dplyr::summarise(flux_mg_m_y = sum(flux_mg_m_y)) %>%
    ungroup %>% group_by(site) %>%
    dplyr::summarise(across(matches('flux'), list(mean = ~mean(.x, na.rm = TRUE),
                                                            quant2.5 = ~quantile(.x, 0.025, na.rm = TRUE),
                                                            quant25 = ~quantile(.x, 0.25, na.rm = TRUE),
                                                            quant50 = ~quantile(.x, 0.50, na.rm = TRUE),
                                                            quant75 = ~quantile(.x, 0.75, na.rm = TRUE),
                                                            quant97.5 = ~quantile(.x, 0.975, na.rm = TRUE)))) %>%
  bind_rows
  min_demand = comm_energy_demand_summary %>% dplyr::slice(which.min(flux_mg_m_y_mean))
  max_demand = comm_energy_demand_summary %>% dplyr::slice(which.max(flux_mg_m_y_mean))
  
drake::loadd(flux_summaries)
annual_comm_flux_summary = flux_summaries[["annual_comm_flux_summary"]]
min_flux = annual_comm_flux_summary %>% dplyr::slice(which.min(flux_mg_m_y_mean))
max_flux = annual_comm_flux_summary %>% dplyr::slice(which.max(flux_mg_m_y_mean))

```
## Community OM fluxes

Annual community energy demand mirrored patterns of secondary production previously reported [@junker2020]. Community energy demand varied ~`r round((max_demand$flux_mg_m_y_mean/min_demand$flux_mg_m_y_mean),1)`-fold across streams (`r round((min_demand$flux_mg_m_y_mean/1000), 3)`[`r round((min_demand$flux_mg_m_y_quant2.5/1000),3)` -- `r round((min_demand$flux_mg_m_y_quant97.5/1000),3)`] to `r round((max_demand$flux_mg_m_y_mean/1000),1)` [`r round((max_demand$flux_mg_m_y_quant2.5/1000),1)` -- `r round((max_demand$flux_mg_m_y_quant97.5/1000),1)`]; g AFDM $m^{-2} y^{-1}$ mean [95% percentile interval (PI)]) and was positively related to temperature. Total OM flux through the consumer community was strongly associated with community energy demand and varied from `r round((min_flux$flux_mg_m_y_mean/1000),1)` [`r round((min_flux$flux_mg_m_y_quant2.5/1000),1)`--`r round((min_flux$flux_mg_m_y_quant97.5/1000),1)`] to `r round((max_flux$flux_mg_m_y_mean/1000),1)` [`r round((max_flux$flux_mg_m_y_quant2.5/1000),1)`--`r round((max_flux$flux_mg_m_y_quant97.5/1000),1)`] g AFDM $m^{-2} y^{-1}$.

```{r diet import, echo = FALSE, include = TRUE, message=FALSE, warning = FALSE}
drake::loadd(modeled_diets)
diet_predictions_site = modeled_diets[["diet_predictions"]] %>%
   dplyr::mutate(site = factor(site, levels = names(stream_order_list))) %>%
    group_by(site, diet_item) %>%
    dplyr::summarise(across(rel_area, list(mean = ~mean(.x, na.rm = TRUE),
                                                            quant2.5 = ~quantile(.x, 0.025, na.rm = TRUE),
                                                            quant25 = ~quantile(.x, 0.25, na.rm = TRUE),
                                                            quant50 = ~quantile(.x, 0.50, na.rm = TRUE),
                                                            quant75 = ~quantile(.x, 0.75, na.rm = TRUE),
                                                            quant97.5 = ~quantile(.x, 0.975, na.rm = TRUE))))

diet_predictions_item = modeled_diets[["diet_predictions"]] %>%
   dplyr::mutate(site = factor(site, levels = names(stream_order_list))) %>%
    group_by(diet_item) %>%
    dplyr::summarise(across(rel_area, list(mean = ~mean(.x, na.rm = TRUE),
                                                            quant2.5 = ~quantile(.x, 0.025, na.rm = TRUE),
                                                            quant25 = ~quantile(.x, 0.25, na.rm = TRUE),
                                                            quant50 = ~quantile(.x, 0.50, na.rm = TRUE),
                                                            quant75 = ~quantile(.x, 0.75, na.rm = TRUE),
                                                            quant97.5 = ~quantile(.x, 0.975, na.rm = TRUE))))

drake::loadd(diet_similarity)
min_within_overlap = diet_similarity[['within_overlap_summ']] %>% dplyr::slice_min(meanoverlap_mean)
max_within_overlap = diet_similarity[['within_overlap_summ']] %>% dplyr::slice_max(meanoverlap_mean)

# min_among_overlap = diet_similarity[[]]

among_overlap_mean = mean(diet_similarity[['among_overlap_mean']], na.rm = TRUE)
among_overlap_quant2.5 = quantile(diet_similarity[['among_overlap_mean']], 0.025, na.rm = TRUE)
among_overlap_quant97.5 = quantile(diet_similarity[['among_overlap_mean']], 0.975, na.rm = TRUE)

```

Patterns of OM flux among streams were most closely tied to total consumer energy demands as consumer diets exhibited high similarity among streams (Supporting Materials, Figure SX). Diets composition among all streams were dominated by diatoms (`r diet_predictions_item %>% dplyr::filter(diet_item == "diatom") %>% select(contains('mean')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`% [`r diet_predictions_item %>% dplyr::filter(diet_item == "diatom") %>% select(contains('quant2.5')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`--`r diet_predictions_item %>% dplyr::filter(diet_item == "diatom") %>% select(contains('quant97.5')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`]), amorphous detritus (`r diet_predictions_item %>% dplyr::filter(diet_item == "amorphous_detritus") %>% select(contains('mean')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`% [`r diet_predictions_item %>% dplyr::filter(diet_item == "amorphous_detritus") %>% select(contains('quant2.5')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`--`r diet_predictions_item %>% dplyr::filter(diet_item == "amorphous_detritus") %>% select(contains('quant97.5')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`]), and green algae (`r diet_predictions_item %>% dplyr::filter(diet_item == "green_algae") %>% select(contains('mean')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`% [`r diet_predictions_item %>% dplyr::filter(diet_item == "green_algae") %>% select(contains('quant2.5')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`--`r diet_predictions_item %>% dplyr::filter(diet_item == "green_algae") %>% select(contains('quant97.5')) %>% dplyr::mutate(across(.fns = ~.x*100)) %>% round(1)`]). Within streams, diet similarity ranged from `r min_within_overlap %>% dplyr::select(meanoverlap_mean) %>% round(2)` (`r round(min_within_overlap$meanoverlap_quant2.5,2)` -- `r round(min_within_overlap$meanoverlap_quant97.5,2)`) to `r max_within_overlap %>% dplyr::select(meanoverlap_mean) %>% round(2)` (`r round(max_within_overlap$meanoverlap_quant2.5,2)` -- `r round(max_within_overlap$meanoverlap_quant97.5,2)`) among all consumer taxa. Among streams, diet overlap was similarly high and mean overlap among all streams was `r round(among_overlap_mean,2)`% (`r round(among_overlap_quant2.5,2)` -- `r round(among_overlap_quant97.5,2)` 95% PI). Diet similarity of pairwise comparisons among streams showed little differences in diet among streams and no clear relationship with temperature.

## Evenness of OM fluxes within streams 

```{r species richness, echo = FALSE, warning=FALSE, message=FALSE}
spp_richness = energy_demand %>% group_by(site) %>% dplyr::summarise(taxon_n = n_distinct(taxon))

drake::loadd(gini_analysis)
gini_summary = gini_analysis[["stream_gini_summary"]] %>% set_names(make.names(names(.)))

```

Generally, OM fluxes were distributed unevenly among consumers, however, the extent varied among streams (Figure 1; Figure S1). Gini inequality coefficients ranged from `r gini_summary %>% select('Non.normalized.Gini_mean') %>% min %>% round(2)` [`r gini_summary %>% data.frame %>% dplyr::slice_min(Non.normalized.Gini_mean) %>% select(Non.normalized.Gini_quant2.5) %>% round(2)` -- `r gini_summary %>% data.frame %>% dplyr::slice_min(Non.normalized.Gini_mean) %>%  select('Non.normalized.Gini_quant97.5') %>% round(2)`] to `r gini_summary %>% data.frame %>% dplyr::slice_max(Non.normalized.Gini_mean) %>%  select('Non.normalized.Gini_mean') %>% round(2)` [`r gini_summary %>% data.frame %>% dplyr::slice_max(Non.normalized.Gini_mean) %>% select('Non.normalized.Gini_quant2.5') %>% round(2)` -- `r gini_summary %>% data.frame %>% dplyr::slice_max(Non.normalized.Gini_mean) %>% select('Non.normalized.Gini_quant97.5') %>% round(2)`]; Table 1). Differences in inequality were partly attributed to variation in consumer species richness among streams which ranged from `r spp_richness %>% select(taxon_n) %>% min` to `r spp_richness %>% select(taxon_n) %>% max` consumers. Yet, even after accounting for differences in consumer richness, patterns of material fluxes were still unevenly distributed among consumers (Normalized Gini coefficient: `r gini_summary %>% select('Normalized.Gini_mean') %>% min %>% round(2)` [`r gini_summary %>% data.frame %>% dplyr::slice_min(Normalized.Gini_mean) %>% select(Normalized.Gini_quant2.5) %>% round(2)` -- `r gini_summary %>% data.frame %>% dplyr::slice_min(Normalized.Gini_mean) %>%  select('Normalized.Gini_quant97.5') %>% round(2)`] to `r gini_summary %>% data.frame %>% dplyr::slice_max(Normalized.Gini_mean) %>%  select('Normalized.Gini_mean') %>% round(2)` [`r gini_summary %>% data.frame %>% dplyr::slice_max(Normalized.Gini_mean) %>% select('Normalized.Gini_quant2.5') %>% round(2)` -- `r gini_summary %>% data.frame %>% dplyr::slice_max(Normalized.Gini_mean) %>% select('Normalized.Gini_quant97.5') %>% round(2)`]; Table 1).

```{r GINI table, echo = FALSE, warning=FALSE, message=FALSE}
drake::loadd(gini_analysis)
tab1_caption = "Table 1. Evenness of energy fluxes among consumers within a stream community measured by the Gini index, both raw (\\'non-normalized\\') and \\'normalized\\' for consumer richness"
gini_analysis[["stream_gini_summary"]] %>% 
   dplyr::mutate(across(where(is.numeric),.fns = ~signif(.,2))) %>% 
   dplyr::mutate("Non-normalized Gini" = paste0(`Non-normalized Gini_mean`," ( ",`Non-normalized Gini_quant2.5`," - ", `Non-normalized Gini_quant97.5`," )"),
                 "Normalized Gini" = paste0(`Normalized Gini_mean`," ( ", `Normalized Gini_quant2.5`," - ", `Normalized Gini_quant97.5`," )")) %>% select(site, `Non-normalized Gini`,`Normalized Gini`) %>%
   dplyr::mutate(site = factor(site, levels = names(stream_order_list))) %>%
   knitr::kable(align = "lrr", caption = tab1_caption)

```


```{r spp flux summaries, echo = FALSE, warning=FALSE, message=FALSE}
drake::loadd(spp_rankings_summary)
spp_flux_summary = spp_rankings_summary[["prod_spp_rank"]]
select_dom = function(x){
  x= x[which(!is.na(x$taxon)),]
  x = x %>% dplyr::mutate(tot_n = max(prod_ann_rank, na.rm = TRUE))
  if(sum(x$rel_flux >= 0.15) > 1){
    y = x[which(x$rel_flux >= 0.15),]
    } else{
      y = x[which(x$prod_ann_rank >= (max(x$prod_ann_rank)-1)),]
   }
  return(y)
}

spp_dominance = spp_flux_summary %>% named_group_split(site) %>% map(.,~select_dom(.x)) %>% bind_rows(.id = 'site') %>% 
  group_by(site) %>%
  dplyr::summarise(n_dom = n(), 
                   tot_n = unique(tot_n),
                   dom_flux = 1-min(rel_flux, na.rm = TRUE), 
                   dom_spp = 1-min(rel_spp))

n_dom_min = spp_dominance %>% dplyr::slice_min(n_dom)
n_dom_max = spp_dominance %>% dplyr::slice_max(n_dom)

perc_dom_min = spp_dominance %>% dplyr::slice(which.min(dom_spp))
perc_dom_max = spp_dominance %>% dplyr::slice(which.max(dom_spp))


```

Variation in the relative distribution of OM fluxes among consumers corresponded to different patterns of dominance across streams (Figure 1). For example, in an absolute sense, ~85% of total flux was contributed by `r n_dom_min$n_dom` to `r n_dom_max$n_dom` species. Relatively, this flux was attributed by `r round(perc_dom_min$dom_spp*100,0)`% to `r round(perc_dom_max$dom_spp*100,0)`% of the species assemblages within streams. Differences in dominance were unrelated to temperature, however, species dominance in relation to population traits exhibited important differences along the temperature gradient. 

```{r figure 1., echo = FALSE, warning = FALSE, message = FALSE, fig.width=5, fig.height=5, dpi = 450, fig.cap="Figure 1."}
drake::loadd(annual_spp_flux_fig)
annual_spp_flux_fig
```

## OM fluxes along species trait distributions among sites and taxa

```{r trait summary, echo = FALSE, warning=FALSE, message=FALSE}
drake::loadd(spp_rankings_summary)
pb_summ = spp_rankings_summary[["PB_spp_rank"]] %>% na.omit %>% group_by(site) %>% dplyr::summarise(across(matches("pb.*mean"), ~mean(.x,na.rm = TRUE)))

m_summ = spp_rankings_summary[["M_spp_rank"]] %>% na.omit %>% group_by(site) %>% dplyr::summarise(across(matches(".*ind_mean"), ~mean(.x,na.rm = TRUE)))

M_temp_coefs = temperature_stats[["M_temp_coefs"]]
M_temp_coef_mean = round((exp(mean(M_temp_coefs, na.rm = TRUE)) -1)*100,1)
M_temp_coef_quant2.5 = round((exp(quantile(M_temp_coefs, 0.025, na.rm = TRUE))-1)*100,1)
M_temp_coef_quant97.5 = round((exp(quantile(M_temp_coefs, 0.975, na.rm = TRUE))-1)*100,1)

pb_temp_coefs = temperature_stats[["pb_temp_coefs"]]
pb_temp_coef_mean = round((exp(mean(pb_temp_coefs, na.rm = TRUE))-1)*100,1)
pb_temp_coef_quant2.5 = round((exp(quantile(pb_temp_coefs, 0.025, na.rm = TRUE))-1)*100,1)
pb_temp_coef_quant97.5 = round((exp(quantile(pb_temp_coefs, 0.975, na.rm = TRUE))-1)*100,1)

# analyze skewness with temperature
M_skew_temp_coefs = temperature_stats[["M_skew_temp_coefs"]]
M_skew_temp_coef_mean = round(mean(M_skew_temp_coefs, na.rm = TRUE), 2)
M_skew_temp_coef_median = round(mean(M_skew_temp_coefs, na.rm = TRUE), 2)
M_skew_temp_coef_quant2.5 = round(quantile(M_skew_temp_coefs, 0.025, na.rm = TRUE),2)
M_skew_temp_coef_quant97.5 = round(quantile(M_skew_temp_coefs, 0.975, na.rm = TRUE),2)

pb_skew_temp_coefs = temperature_stats[["pb_skew_temp_coefs"]]
pb_skew_temp_coef_mean = round(mean(pb_skew_temp_coefs, na.rm = TRUE),2)
pb_skew_temp_coef_quant2.5 = round(quantile(pb_skew_temp_coefs, 0.025, na.rm = TRUE),2)
pb_skew_temp_coef_quant97.5 = round(quantile(pb_skew_temp_coefs, 0.975, na.rm = TRUE),2)

drake::loadd(skew_analysis)

pb_skew_summ = skew_analysis[["pb_skew_summ"]]

m_skew_summ = skew_analysis[["M_skew_summ"]]
```

The fluxes of OM were distributed differently across body sizes and turnover rates (*P:B*) among and within streams. Across streams, mean body size of taxa ranged from `r m_summ %>% slice_min(M_mg_ind_mean) %>% select(M_mg_ind_mean) %>% round(2)` to `r m_summ %>% slice_max(M_mg_ind_mean) %>% select(M_mg_ind_mean)%>% round(2)` mg ind^-1^ and mean annual P:B ranged from `r pb_summ %>% slice_min(pb_y_mean) %>% select(pb_y_mean)%>% round(2)` to `r pb_summ %>% slice_max(pb_y_mean) %>% select(pb_y_mean)%>% round(2)` (Figure 2). Both, *M* and *P:B* showed associations with mean annual stream temperature that were negative and positive, respectively. Generally, mean *M* of the community decreased `r M_temp_coef_mean`% (95% PI, `r M_temp_coef_quant2.5`% -- `r M_temp_coef_quant97.5`%) for each increase in 1$^\circ$C. In contrast, mean population *P:B* of the community increased `r pb_temp_coef_mean`% (95% PI, `r pb_temp_coef_quant2.5`% -- `r pb_temp_coef_quant97.5`%) for each 1$^\circ$C in mean annual stream temperature. Energy fluxes within consumer communities were skewed towards larger body sizes (positive skew), towards smaller body sizes (negative skew), or neutrally in regards to body size  among streams, with skew estimates with body size (*M*) ranging from `r m_skew_summ %>% slice_min(abs(M_mg_ind_skew_mean)) %>% select(M_mg_ind_skew_mean)%>% round(2)` to `r m_skew_summ %>% slice_max(abs(M_mg_ind_skew_mean)) %>% select(M_mg_ind_skew_mean) %>% round(2)` (Figure 3, Table 2). Similarly, skew in fluxes towards high turnover taxa varied among streams ranging from `r pb_skew_summ %>% slice_min(abs(pb_y_skew_mean)) %>% select(pb_y_skew_mean) %>% round(2)` to `r pb_skew_summ %>% slice_max(abs(pb_y_skew_mean)) %>% select(pb_y_skew_mean) %>% round(2)` (Figure 3, Table 2).

```{r trait hist, echo=FALSE, warning=FALSE, message=FALSE, fig.width=5, fig.height=5, dpi = 450, fig.cap="Figure 2."}
drake::loadd(spp_trait_histograms)
grid.draw(spp_trait_histograms)
```

The skew of energy fluxes towards populations with smaller/larger body sizes showed some systematic variation with stream temperature (Figure 4). The median effect size of increasing temperature was to shift the skewness coefficient, $Sk_{flux}$, `r M_skew_temp_coef_median` units (`r M_skew_temp_coef_quant2.5` -- `r M_skew_temp_coef_quant97.5` 95% PI) for every 1 $^\circ$C increase. While the 95% PI contained zero, the estimated effect of temperature on $Sk_{flux}$ towards lower body size populations exhibited a bimodal distribution around zero (Figure SXa), however, `r round((sum(M_skew_temp_coefs < 0)/n_boot)*100,1)`% of values fell below zero (Figure SXa). Similarly, energy fluxes through the community skewed increasingly toward higher turnover (*P:B*) organisms with increasing temperature. The median increase in $Sk_{flux}$ towards higher *P:B* populations was `r pb_skew_temp_coef_mean` (`r pb_skew_temp_coef_quant2.5` -- `r pb_skew_temp_coef_quant97.5` 95% PI; Figure 4), with `r round((sum(pb_skew_temp_coefs >= 0)/n_boot)*100,1)`% of estimates above zero.

```{r lorenz analysis, echo =FALSE, warning=FALSE, message=FALSE, fig.width=5, fig.height=5, dpi = 450, fig.cap="Figure 3."}
drake::loadd(lorenz_trait_fig)
grid.arrange(lorenz_trait_fig[["M_lorenz_flux_plot"]], lorenz_trait_fig[["pb_lorenz_flux_plot"]], ncol = 2, bottom = textGrob("Cumulative relative species", vjust = 1, gp = gpar(fontfamily = 'serif')),
                         left = textGrob("Cumulative relative flux", rot = 90, vjust = 1, gp = gpar(fontfamily = 'serif')))

```

We compared the empirical $Sk_{flux}$ measurement within streams to a random ordering to detect random vs. non-random structure in community energy fluxes. The probability of observing a similar or more extreme skew of within stream OM fluxes in relation to species body size ranged from `r m_skew_summ %>% slice_min(M_skew_prob_mean) %>% select(matches("M.*prob_mean")) %>% round(2)` (`r m_skew_summ %>% slice_min(M_skew_prob_mean) %>% select(matches("M.*prob_quant2.5")) %>% round(2)` -- `r m_skew_summ %>% slice_min(M_skew_prob_mean) %>% select(matches("M.*prob_quant97.5")) %>% round(2)`) to `r m_skew_summ %>% slice_max(M_skew_prob_mean) %>% select(matches("M.*prob_mean")) %>% round(2)` (`r m_skew_summ %>% slice_max(M_skew_prob_mean) %>% select(matches("M.*prob_quant2.5")) %>% round(2)` -- `r m_skew_summ %>% slice_max(M_skew_prob_mean) %>% select(matches("M.*prob_quant97.5")) %>% round(2)`). Similarly, the probability of a more extremely skewed distribution in relation to population *P:B* ranged from `r pb_skew_summ %>% slice_min(pb_skew_prob_mean) %>% select(matches("pb.*prob_mean")) %>% round(2)` (`r pb_skew_summ %>% slice_min(pb_skew_prob_mean) %>% select(matches("pb.*prob_quant2.5")) %>% round(2)` -- `r pb_skew_summ %>% slice_min(pb_skew_prob_mean) %>% select(matches("pb.*prob_quant97.5")) %>% round(2)`) to `r pb_skew_summ %>% slice_max(pb_skew_prob_mean) %>% select(matches("pb.*prob_mean")) %>% round(2)` (`r pb_skew_summ %>% slice_max(pb_skew_prob_mean) %>% select(matches("pb.*prob_quant2.5")) %>% round(2)` -- `r pb_skew_summ %>% slice_max(pb_skew_prob_mean) %>% select(matches("pb.*prob_quant97.5")) %>% round(2)`). The probability that energy fluxes were organized randomly or non-randomly in regards to body size showed no clear association with temperature (Figure S5), however, there was a trend towards community energy fluxes becoming more organized (less "randomly" structured) in relation to biomass turnover with increasing temperatures (Figure XX). This relationship exhibited a concave up relationship with temperature, showing a clear trend toward less-random organization from cool to mid-range temperatures and returning towards a more likely random organization at the warmest stream.

```{r skew statistics, echo=FALSE, warning=FALSE, message=FALSE}

```

```{r skew distribution, echo = FALSE, warning=FALSE, message=FALSE, fig.cap="Figure 4. "}
drake::loadd(random_skew_fig)
grid.arrange(random_skew_fig[["M_perc_plot"]], random_skew_fig[["pb_perc_plot"]], ncol = 1, left = text_grob(""))

```

```{r skew prob temp, echo = FALSE, warning=FALSE, message=FALSE}
drake::loadd(temperature_skew_fig)
 temperature_skew_fig
```

# Discussion

Rising global temperatures are altering the pathways of energy flow across and within ecosystems with potential consequences for the services they provide. Here, we document shifting energy flow pathways across a wide natural temperature gradient to show that while increasing mean annual temperatures led to expected reductions in mean community body size and increases in mean biomass turnover rates across stream consumer communities, increasing temperatures also systematically skewed energy fluxes *within* communities. Here, energy fluxes were skewed towards smaller, quick turnover populations at warmer temperatures and showed increasingly non-random organization moving from cooler to warmer temperatures. but this trend reversed at the warmest temperatures. The tendency for energy fluxes to be dominated by relatively higher turnover populations at warmer temperatures and this organization to be increasingly non-random, suggests warming may speed up energy fluxes through ecosystems in both an absolute and relative sense.

Increasing global temperatures

[@diaz2021a] SAD are more uneven than their statistical background
While a growing body of theoretical and empirical study has enhanced our knowledge of temperature-mediated changes to ecosystems [\ e.g., @oconnor2009], general patterns are uncertain and empirical studies often idiosyncratic [@zhang2017; @nelson2017], especially at higher levels of organizations such as communities and food webs [@walther2002; @woodward2010]. Yet, identifying general effects of temperature is a necessary step towards understanding how future warming may alter the functioning of ecosystems and the services they provide.

# Acknowledgements

We are grateful to Sigurður Guðjonsson, Guðni Guðbergsson, and the staff at the Veiðimlastofnun for providing laboratory space and logistical support. We are also grateful to Sveinbj€orn Steinþorsson at the University of Iceland for super-jeep transport to our field sites during the winter. Jeff Wesner and Abe Kanz for code sharing and discussions on modeling diet proportions.

# References

<div id="refs"></div>
